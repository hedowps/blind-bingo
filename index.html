<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Blind Bingo</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
    h1 { text-align: center; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(8, 80px);
      grid-gap: 8px;
      justify-content: center;
      margin: 20px 0;
    }
    .cell {
      width: 80px;
      height: 80px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
      background: #f0f0f0;
      text-align: center;
      padding: 4px;
      box-shadow: 0 0 2px rgba(0,0,0,0.2);
    }
    .cell.disabled {
      cursor: default;
      opacity: 0.8;
    }
    .cell.win {
      background: #d1ffd1;
      border: 2px solid #4caf50;
    }
    .cell.lose {
      background: #ffd1d1;
      border: 2px solid #f44336;
    }
    .name-input {
      padding: 6px;
      font-size: 14px;
      min-width: 200px;
    }
    button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .admin-section {
      margin-top: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #f5f5f5;
    }
    .small {
      font-size: 11px;
      color: #555;
    }
  </style>
</head>
<body>

<h1>Blind Bingo</h1>

<div class="top-bar">
  <div>
    <label>Ditt namn:
      <input class="name-input" id="playerName" placeholder="Skriv ditt namn">
    </label>
  </div>
  <div>
    <button onclick="saveName()">Spara namn</button>
    <button onclick="refreshAll()">Uppdatera</button>
    <button onclick="newGame()">Nytt spel (admin)</button>
  </div>
</div>

<p class="small">
  Skriv in ditt namn f√∂rst. N√§r du klickar p√• en ruta sparas dina initialer i rutan
  och alla som har sidan √∂ppen ser resultatet.
</p>

<div id="grid" class="grid"></div>

<div class="admin-section">
  <h2>Adminpanel ‚Äì logg</h2>
  <p class="small">Alla som har l√§nken kan se loggen.</p>
  <table>
    <thead>
      <tr>
        <th>Tid</th>
        <th>Namn</th>
        <th>Cellindex</th>
        <th>Tickets</th>
      </tr>
    </thead>
    <tbody id="logBody"></tbody>
  </table>
</div>

<script>
  const API_URL = https://script.google.com/macros/library/d/12uOuaeg8LZ6Y4WtmVbrZe6cbFpmlSw56lNRkzZYkecEiKTjqaEmejB8w/3; 
  // ================================================

  let boardData = null;

  function getInitials(name) {
    if (!name) return "";
    return name.trim().split(/\s+/).map(p => p[0].toUpperCase()).join("");
  }

  function saveName() {
    const name = document.getElementById("playerName").value.trim();
    if (!name) {
      alert("Skriv in ett namn f√∂rst.");
      return;
    }
    localStorage.setItem("bingoName", name);
    alert("Namn sparat!");
  }

  function loadName() {
    const stored = localStorage.getItem("bingoName");
    if (stored) document.getElementById("playerName").value = stored;
  }

  async function apiGet(action) {
    const res = await fetch(API_URL + "?action=" + encodeURIComponent(action));
    return res.json();
  }

  async function apiPost(action, data) {
    const res = await fetch(API_URL + "?action=" + encodeURIComponent(action), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data || {})
    });
    return res.json();
  }

  function buildGrid() {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    if (!boardData || !boardData.cells || boardData.cells.length === 0) {
      grid.innerHTML = "<p>Inget spel √§nnu. Klicka p√• 'Nytt spel (admin)'.</p>";
      return;
    }

    boardData.cells.forEach(cell => {
      const div = document.createElement("div");
      div.className = "cell";
      div.dataset.index = cell.index;

      let contentTop = "";
      let contentBottom = "";

      if (cell.clickedBy) {
        const initials = getInitials(cell.clickedBy);
        contentTop = initials;
        if (cell.tickets && cell.tickets > 0) {
          contentBottom = cell.tickets + " üéüÔ∏è";
          div.classList.add("win", "disabled");
        } else {
          contentBottom = "Nit";
          div.classList.add("lose", "disabled");
        }
      } else {
        contentTop = "?";
      }

      div.innerHTML = `
        <div>${contentTop}</div>
        <div>${contentBottom}</div>
      `;

      if (!cell.clickedBy) {
        div.addEventListener("click", onCellClick);
      }

      grid.appendChild(div);
    });
  }

  async function onCellClick(e) {
    const name = document.getElementById("playerName").value.trim();
    if (!name) {
      alert("Skriv in ditt namn och klicka p√• 'Spara namn' f√∂rst.");
      return;
    }
    const index = Number(e.currentTarget.dataset.index);

    try {
      const result = await apiPost("clickCell", { index, name });
      if (result.error) {
        alert("Fel: " + result.error);
        return;
      }
      if (result.alreadyClicked) {
        alert("Den h√§r rutan har redan tagits av: " + result.clickedBy);
      } else {
        if (result.tickets > 0) {
          alert(`Grattis ${name}! Du fick ${result.tickets} ticket(s).`);
        } else {
          alert(`Tyv√§rr ${name}, det blev nitlott.`);
        }
      }
      refreshAll();
    } catch (err) {
      alert("Tekniskt fel vid klick.");
      console.error(err);
    }
  }

  function buildLog(logs) {
    const body = document.getElementById("logBody");
    body.innerHTML = "";
    logs.forEach(entry => {
      const tr = document.createElement("tr");
      const time = entry.time ? new Date(entry.time).toLocaleString() : "";
      tr.innerHTML = `
        <td>${time}</td>
        <td>${entry.name}</td>
        <td>${entry.index}</td>
        <td>${entry.tickets}</td>
      `;
      body.appendChild(tr);
    });
  }

  async function refreshAll() {
    try {
      const [board, logs] = await Promise.all([
        apiGet("getBoard"),
        apiGet("getLog")
      ]);
      if (!board.error) {
        boardData = board;
        buildGrid();
      }
      if (!logs.error) {
        buildLog(logs);
      }
    } catch (err) {
      console.error(err);
    }
  }

  async function newGame() {
    const name = document.getElementById("playerName").value.trim();
    // superenkel "admin-s√§kring" ‚Äì byt ut mot ditt namn om du vill:
    if (name !== "Hedvig Oppitz") {
      if (!confirm("Du heter inte Hedvig, √§r du S√ÑKER p√• att du ska starta nytt spel?")) {
        return;
      }
    }
    if (!confirm("Starta nytt spel? Detta rensar br√§det och loggen.")) return;

    try {
      const res = await apiGet("newGame");
      if (res.error) {
        alert("Fel vid nytt spel: " + res.error);
      } else {
        refreshAll();
      }
    } catch (err) {
      alert("Tekniskt fel vid nytt spel.");
      console.error(err);
    }
  }

  window.onload = function() {
    loadName();
    refreshAll();
    setInterval(refreshAll, 15000); // uppdatera var 15:e sekund
  };
</script>

</body>
</html>
